<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Brugmelding</title>

  <!-- Zoom op de website uitschakelen op mobiel -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <link rel="icon" href="/favicon.ico" />
  <link rel="manifest" href="/manifest.webmanifest" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    :root {
      --accent: #0066ff;
      --green: #2ecc71;
      --red: #e74c3c;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      overflow: hidden;
      background: #f6f6f6;
      color: #222;
      transition: background .3s, color .3s;
    }

    body.dark {
      background: #111;
      color: #eee;
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    /* Zorg dat zoomknoppen onder de top-bar vallen */
    .leaflet-top.leaflet-left {
      margin-top: 60px !important;
    }

    /* TOP BAR */
    .top-bar {
      position: fixed;
      top: 0; left: 0; right: 0;
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0,0,0,0.1);
      z-index: 9000;
    }
    body.dark .top-bar {
      background: rgba(20,20,20,0.9);
      border-color: rgba(255,255,255,0.2);
    }

    .top-branding {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .top-title {
      font-size: 16px;
      font-weight: 600;
    }
    .top-subtitle {
      font-size: 11px;
      opacity: 0.7;
    }
    .top-status {
      font-size: 12px;
      opacity: 0.8;
      flex: 1;
      min-width: 180px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.dark .top-status {
      color: #ddd;
    }

    .theme-toggle {
      padding: 6px 12px;
      border-radius: 999px;
      border: 0;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 12px;
    }
    body.dark .theme-toggle {
      background: #333;
    }

    /* PANELS */
    .map-panel {
      position: fixed;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 8000;
      font-size: 13px;
    }
    body.dark .map-panel {
      background: rgba(20,20,20,0.92);
      color: #eee;
    }

    .map-panel.controls {
      left: 10px;
      bottom: 100px;
      max-width: 240px;
    }

    .map-panel.legend-panel {
      right: 10px;
      bottom: 100px;
    }

    .section-label {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.6;
      margin-bottom: 3px;
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.25);
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .chip.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    body.dark .chip {
      background: #333;
      border-color: #555;
    }

    .sheet-input,
    .sheet-select {
      width: 100%;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.25);
      margin-top: 4px;
      background: #fff;
      font-size: 13px;
    }
    body.dark .sheet-input,
    body.dark .sheet-select {
      background: #222;
      border-color: #555;
      color: #eee;
    }

    /* LEGEND */
    .legend-line {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 4px 0;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .legend-dot.closed {
      background: var(--green);
    }
    .legend-dot.open {
      background: var(--red);
    }

    /* DETAILSHEET */
    .sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.97);
      backdrop-filter: blur(14px);
      border-radius: 16px 16px 0 0;
      transform: translateY(calc(100% - 60px));
      max-height: 65vh;
      padding-bottom: 16px;
      transition: transform .35s ease;
      z-index: 8500;
    }
    body.dark .sheet {
      background: rgba(20,20,20,0.97);
    }
    .sheet.expanded {
      transform: translateY(0);
    }

    .sheet-header {
      padding: 10px 16px;
      cursor: pointer;
    }
    .sheet-handle {
      width: 40px;
      height: 4px;
      border-radius: 999px;
      background: rgba(0,0,0,0.25);
      margin: 0 auto 6px auto;
    }
    body.dark .sheet-handle {
      background: rgba(255,255,255,0.25);
    }

    .sheet-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .sheet-title {
      font-size: 15px;
      font-weight: 600;
    }
    .sheet-subtitle {
      font-size: 12px;
      opacity: 0.7;
    }

    .sheet-body {
      padding: 12px 16px;
      border-top: 1px solid rgba(0,0,0,0.1);
      font-size: 13px;
      overflow-y: auto;
      height: 100%;
    }
    body.dark .sheet-body {
      border-color: #444;
    }

    .badge-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
    }
	
    .badge-status.closed {
      background: rgba(46,204,113,0.18);
      color: var(--green);
    }
    .badge-status.open {
      background: rgba(231,76,60,0.18);
      color: var(--red);
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .history-section {
      margin-top: 12px;
    }
    .history-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .history-summary {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 6px;
    }
    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 240px;
      overflow-y: auto;
      padding-right: 2px;
      -webkit-overflow-scrolling: touch;
    }
    .history-item {
      padding: 8px 10px;
      border-radius: 8px;
      background: rgba(0,0,0,0.04);
      border: 1px solid rgba(0,0,0,0.05);
    }
    body.dark .history-item {
      background: rgba(255,255,255,0.04);
      border-color: rgba(255,255,255,0.08);
    }

    /* LOCATIE KNOP ‚Äì netjes rechtsboven onder de topbar */
    .loc-btn {
      position: fixed;
      right: 12px;
      top: 70px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9000;
      user-select: none;
      font-size: 18px;
    }
    body.dark .loc-btn {
      background: #333;
      color: #fff;
    }

    /* WATERMARK */
    .watermark {
      position: fixed;
      bottom: 6px;
      left: 6px;
      font-size: 10px;
      opacity: 0.25;
      z-index: 4000;
      pointer-events: none;
    }
    body.dark .watermark {
      color: #fff;
    }
  </style>
</head>

<body>

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="top-branding">
      <div class="top-title">Brugmelding</div>
      <div class="top-subtitle">NDW ‚Äì brugopeningen NL</div>
    </div>

    <div class="top-status" id="updateStatus" aria-live="polite">Laatste update: laden‚Ä¶</div>

    <button class="theme-toggle" id="themeToggle">
      <span class="icon">üåô</span>
      <span class="label">Dark mode</span>
    </button>
  </div>

  <!-- MAP -->
  <div id="map"></div>

  <!-- LOCATIE KNOP -->
  <div class="loc-btn" id="locBtn" title="Mijn locatie">üìç</div>

  <!-- WATERMARK -->
  <div class="watermark">Data: NDW</div>

  <!-- FILTER PANEL -->
  <div class="map-panel controls">
    <div class="section-label">Status</div>
    <div class="chip-group">
      <div class="chip active" id="fAll">Alle</div>
      <div class="chip" id="fOpen">Open</div>
      <div class="chip" id="fClosed">Dicht</div>
    </div>

    <div hidden class="section-label">Provincie</div>
    <select hidden id="provinceFilter" class="sheet-select">
      <option value="all">Alle provincies</option>
    </select>

    <div class="section-label">Zoeken</div>
    <input id="searchInput" class="sheet-input" placeholder="Bijv. Cruquiusbrug‚Ä¶" />
  </div>

  <!-- LEGENDA -->
  <div class="map-panel legend-panel">
    <div class="legend-line"><span class="legend-dot open"></span> Open</div>
    <div class="legend-line"><span class="legend-dot closed"></span> Dicht</div>
  </div>

  <!-- DETAILSHEET -->
    <div class="sheet" id="sheet">
      <div class="sheet-header" id="sheetHeader">
        <div class="sheet-handle"></div>
        <div class="sheet-title-row">
          <div class="sheet-title" id="sheetTitle">Geen brug geselecteerd</div>
          <div class="badge-status" id="sheetStatus" hidden>
            <span class="badge-dot"></span>
            <strong id="sheetStatusText">-</strong>
          </div>
        </div>
        <div class="sheet-subtitle" id="sheetSubtitle">Tik op een brug‚Ä¶</div>
      </div>

    <div class="sheet-body">
      <dl id="bridgeDetails">
        <div>Nog niets geselecteerd.</div>
      </dl>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    const NL_TIMEZONE = "Europe/Amsterdam";

    const dateTimeFormatter = new Intl.DateTimeFormat("nl-NL", {
      timeZone: NL_TIMEZONE,
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
    });

    const dateFormatter = new Intl.DateTimeFormat("nl-NL", {
      timeZone: NL_TIMEZONE,
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
    });

    const timeFormatter = new Intl.DateTimeFormat("nl-NL", {
      timeZone: NL_TIMEZONE,
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
    });

    /* MAP INIT */
    const map = L.map("map").setView([52.2, 5.3], 7);

    const lightTiles = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:19});
    const darkTiles  = L.tileLayer("https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {maxZoom:19});

    let theme = localStorage.getItem("theme") || "light";
    document.body.classList.toggle("dark", theme === "dark");
    (theme === "dark" ? darkTiles : lightTiles).addTo(map);

    const cluster = L.markerClusterGroup();
    map.addLayer(cluster);

    const iconOpen = L.icon({ iconUrl:"brug_open.png", iconSize:[28,28] });
    const iconClosed = L.icon({ iconUrl:"brug_dicht.png", iconSize:[28,28] });

    /* THEME TOGGLE */
    const themeToggle = document.getElementById("themeToggle");
    function updateThemeBtn() {
      themeToggle.querySelector(".label").textContent =
        theme === "light" ? "Dark mode" : "Light mode";
      themeToggle.querySelector(".icon").textContent =
        theme === "light" ? "üåô" : "‚òÄÔ∏è";
    }
    updateThemeBtn();

    themeToggle.onclick = () => {
      theme = theme === "light" ? "dark" : "light";
      document.body.classList.toggle("dark", theme === "dark");
      map.removeLayer(lightTiles); map.removeLayer(darkTiles);
      (theme === "dark" ? darkTiles : lightTiles).addTo(map);
      localStorage.setItem("theme", theme);
      updateThemeBtn();
    };

    /* DATA */
    let bruggen = [];
    let markers = [];
    let selectedId = null;

    let statusFilter = "all";
    let provinceFilter = "all";

    const deepLinkSlug = getDeepLinkSlug();
    let deepLinkHandled = false;

    const updateStatusEl = document.getElementById("updateStatus");
    let lastUpdateTime = null;

    async function load() {
      try {
        const response = await fetch("/get/bruggen_open.json");
        const lastModifiedHeader = response.headers.get("last-modified");
        const lastModified = parseDateSafe(lastModifiedHeader);

        const data = await response.json();
        bruggen = data;

        const latestFromData = getLatestUpdateFromData(data);
        const chosenDate = lastModified || latestFromData || new Date();
        setLastUpdateTime(chosenDate);

        updateProvinceOptions();
        renderMarkers();
        applyDeepLinkIfNeeded();
        updateSheet();
      } catch (error) {
        updateTopStatus("Kon brugdata niet laden");
      }
    }

    function renderMarkers() {
      cluster.clearLayers();
      markers = [];

      bruggen.forEach(b => {
        const d = b.Data;
        if (!d) return;

        // Status filter
        if (statusFilter === "open" && !d.open) return;
        if (statusFilter === "closed" && d.open) return;

        // Provincie filter
        const prov = (d.provincie || "").toLowerCase();
        if (provinceFilter !== "all" && prov !== provinceFilter) return;

        const marker = L.marker([d.latitude, d.longitude], {
          icon: d.open ? iconOpen : iconClosed
        });

        marker.on("click", () => {
          focusOnBridge(b, marker.getLatLng());
        });

        cluster.addLayer(marker);
        markers.push({ marker, item: b });
      });
    }

    /* PROVINCIE FILTER */
    const provinceSelect = document.getElementById("provinceFilter");

    function updateProvinceOptions() {
      const set = new Set();
      bruggen.forEach(b => {
        if (b.Data.provincie) set.add(b.Data.provincie);
      });

      const cur = provinceFilter;
      provinceSelect.innerHTML = "<option value='all'>Alle provincies</option>";
      [...set].sort().forEach(p => {
        provinceSelect.innerHTML += `<option value="${p.toLowerCase()}">${p}</option>`;
      });
      provinceSelect.value = cur;
    }

    provinceSelect.onchange = () => {
      provinceFilter = provinceSelect.value;
      renderMarkers();
      clearSheet();
    };

    /* STATUS FILTER BUTTONS */
    document.getElementById("fAll").onclick    = () => setStatus("all");
    document.getElementById("fOpen").onclick   = () => setStatus("open");
    document.getElementById("fClosed").onclick = () => setStatus("closed");

    function setStatus(s) {
      statusFilter = s;
      document.getElementById("fAll").classList.toggle("active", s==="all");
      document.getElementById("fOpen").classList.toggle("active", s==="open");
      document.getElementById("fClosed").classList.toggle("active", s==="closed");
      renderMarkers();
      clearSheet();
    }

    /* ZOEKEN */
    const searchInput = document.getElementById("searchInput");
    searchInput.oninput = () => {
      const q = searchInput.value.toLowerCase();
      if (!q) return;
      const m = markers.find(m =>
        (m.item.Data.Naam || "").toLowerCase().includes(q)
      );
      if (m) {
        selectedId = m.item.Id;
        showDetails(m.item);
        sheet.classList.add("expanded");
        map.flyTo(m.marker.getLatLng(), 14);
      }
    };

    /* DETAILSHEET */
    const sheet = document.getElementById("sheet");
    const sheetHeader = document.getElementById("sheetHeader");
    const sheetTitle = document.getElementById("sheetTitle");
    const sheetStatus = document.getElementById("sheetStatus");
    const sheetStatusText = document.getElementById("sheetStatusText");
    const sheetSubtitle = document.getElementById("sheetSubtitle");
    const sheetBody = document.getElementById("bridgeDetails");

    sheetHeader.onclick = () => sheet.classList.toggle("expanded");
    map.on("click", () => sheet.classList.remove("expanded"));

    function clearSheet() {
      sheetTitle.textContent = "Geen brug geselecteerd";
      sheetStatus.hidden = true;
      sheetSubtitle.textContent = "Tik op een brug‚Ä¶";
      sheetBody.innerHTML = "<div>Nog niets geselecteerd.</div>";
    }

    function showDetails(b) {
      const d = b.Data;
      const isOpen = !!d.open; // als open true is ‚Üí brugstatus "Open"
      const statusText = isOpen ? "Open" : "Dicht";
      const badgeClass = isOpen ? "open" : "closed";

      sheetTitle.textContent = d.Naam;
      sheetStatus.hidden = false;
      sheetStatus.className = `badge-status ${badgeClass}`;
      sheetStatusText.textContent = statusText;

      const tijd = d.GetDatumStart
        ? new Date(d.GetDatumStart).toLocaleString("nl-NL")
        : "-";

      sheetSubtitle.textContent = `Laatste update: ${tijd}`;

      sheetBody.innerHTML = `
        <div>
          <div class="section-label">Locatie</div>
          <div>Lat: ${d.latitude.toFixed(5)}, Lon: ${d.longitude.toFixed(5)}</div>
        </div>

        <div class="history-section">
          <div class="history-title">Geschiedenis (laatste 24 uur)</div>
          <div class="history-summary" id="historySummary">Totaal open: ‚Ä¶</div>
          <ul class="history-list" id="historyList">
            <li class="history-item">Laden‚Ä¶</li>
          </ul>
        </div>
      `;

      renderHistory(b.Id);
    }

    function updateSheet() {
      if (!selectedId) return;
      const b = bruggen.find(x => x.Id === selectedId);
      if (b) showDetails(b);
    }

    function slugify(str) {
      return (str || "")
        .toString()
        .toLowerCase()
        .replace(/[\s_]+/g, "-")
        .replace(/[^a-z0-9-]/g, "")
        .replace(/-{2,}/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    function getDeepLinkSlug() {
      const path = decodeURIComponent(window.location.pathname)
        .replace(/^\/+|\/+$/g, "");

      if (!path) return null;
      const firstSegment = path.split("/")[0];
      return slugify(firstSegment);
    }

    function updateUrlForBridge(bridge) {
      const slug = slugify(bridge?.Data?.Naam);
      const newPath = slug ? `/${slug}` : "/";

      if (window.location.pathname !== newPath) {
        history.replaceState({}, "", newPath);
      }
    }

    function focusOnBridge(bridge, latLngOverride = null) {
      selectedId = bridge.Id;
      showDetails(bridge);
      sheet.classList.add("expanded");
      updateUrlForBridge(bridge);

      const markerEntry = markers.find(m => m.item.Id === bridge.Id);
      const targetLatLng = latLngOverride
        || markerEntry?.marker.getLatLng()
        || (bridge.Data?.latitude && bridge.Data?.longitude
            ? [bridge.Data.latitude, bridge.Data.longitude]
            : null);

      if (targetLatLng) {
        map.flyTo(targetLatLng, 14);
      }
    }

    function applyDeepLinkIfNeeded() {
      if (deepLinkHandled || !deepLinkSlug) return;

      const match = bruggen.find(b => slugify(b.Data?.Naam) === deepLinkSlug);
      if (match) {
        focusOnBridge(match);
        deepLinkHandled = true;
      }
    }

    function pad(num) {
      return num.toString().padStart(2, "0");
    }

    function formatDuration(seconds) {
      const s = Math.max(0, Math.floor(seconds || 0));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${pad(h)}:${pad(m)}:${pad(sec)}`;
    }

    function parseDateSafe(value) {
      if (!value) return null;
      const parsed = new Date(value);
      return Number.isNaN(parsed.getTime()) ? null : parsed;
    }

    function getLatestUpdateFromData(items) {
      if (!Array.isArray(items)) return null;

      return items.reduce((latest, item) => {
        const dt = parseDateSafe(item?.Data?.GetDatumStart);
        if (dt && (!latest || dt > latest)) {
          return dt;
        }
        return latest;
      }, null);
    }

    function formatRelativeTimeFromNow(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return null;

      const diffMs = Date.now() - date.getTime();
      const diffSec = Math.max(0, Math.floor(diffMs / 1000));
      if (diffSec < 60) return `${diffSec}s geleden`;

      const diffMin = Math.floor(diffSec / 60);
      if (diffMin < 60) return `${diffMin}m geleden`;

      const diffHours = Math.floor(diffMin / 60);
      const remainingMin = diffMin % 60;
      if (diffHours < 24) return `${diffHours}u ${remainingMin}m geleden`;

      const diffDays = Math.floor(diffHours / 24);
      return `${diffDays}d geleden`;
    }

    function setLastUpdateTime(date) {
      if (date instanceof Date && !Number.isNaN(date.getTime())) {
        lastUpdateTime = date;
      }
      updateTopStatus();
    }

    function updateTopStatus(messageOverride = null) {
      if (!updateStatusEl) return;

      if (messageOverride) {
        updateStatusEl.textContent = messageOverride;
        updateStatusEl.removeAttribute("title");
        return;
      }

      if (!lastUpdateTime) {
        updateStatusEl.textContent = "Laatste update: laden‚Ä¶";
        updateStatusEl.removeAttribute("title");
        return;
      }

      const relative = formatRelativeTimeFromNow(lastUpdateTime);
      updateStatusEl.textContent = relative
        ? `Laatste update: ${relative}`
        : "Laatste update: onbekend";
      updateStatusEl.title = `Bijgewerkt: ${dateTimeFormatter.format(lastUpdateTime)}`;
    }

    function renderHistory(bridgeId) {
      const list = document.getElementById("historyList");
      const summary = document.getElementById("historySummary");
      if (!list) return;

      fetch(`/get/history.php?id=${encodeURIComponent(bridgeId)}&limit=100&hours=24`)
        .then(r => r.json())
        .then(items => {
          const openEvents = Array.isArray(items)
            ? items.filter(item => item.opened_at)
            : [];

          if (openEvents.length === 0) {
            list.innerHTML = '<li class="history-item">Geen gebeurtenissen in de laatste 24 uur.</li>';
            if (summary) summary.textContent = "Totaal open: 00:00:00";
            return;
          }

          let totalSeconds = 0;

          list.innerHTML = openEvents.map(item => {
            const openedAt = item.opened_at ? new Date(item.opened_at) : null;
            const closedAt = item.closed_at ? new Date(item.closed_at) : null;

            const dateStr = openedAt
              ? `${pad(openedAt.getDate())}-${pad(openedAt.getMonth()+1)}-${openedAt.getFullYear()}`
              : "-";
            const openTime = openedAt ? `${pad(openedAt.getHours())}:${pad(openedAt.getMinutes())}` : "-";
            const closeTime = closedAt ? `${pad(closedAt.getHours())}:${pad(closedAt.getMinutes())}` : "-";

            const durationSeconds = typeof item.seconds_since_previous_open === "number"
              ? item.seconds_since_previous_open
              : (openedAt && closedAt) ? (closedAt.getTime() - openedAt.getTime()) / 1000 : null;
            const duration = durationSeconds !== null && durationSeconds !== undefined
              ? formatDuration(durationSeconds)
              : "-";

            if (typeof durationSeconds === "number") {
              totalSeconds += durationSeconds;
            }

            return `<li class="history-item">${dateStr} - ${openTime} - ${closeTime} - ${duration}</li>`;
          }).join("");

          if (summary) {
            summary.textContent = `Totaal open: ${formatDuration(totalSeconds)}`;
          }
        })
        .catch(() => {
          list.innerHTML = '<li class="history-item">Kon geschiedenis niet laden.</li>';
          if (summary) summary.textContent = "Totaal open: onbekend";
        });
    }

    /* LOCATIE KNOP */
    let userMarker = null;
    document.getElementById("locBtn").onclick = () => {
      if (!navigator.geolocation) {
        alert("Locatie niet beschikbaar");
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        if (!userMarker) {
          userMarker = L.marker([lat,lon], {
            icon: L.divIcon({
              html: `<div style="width:14px;height:14px;border-radius:999px;border:2px solid white;background:#3498db"></div>`,
              className: "",
              iconSize:[16,16]
            })
          }).addTo(map);
        } else {
          userMarker.setLatLng([lat,lon]);
        }

        map.flyTo([lat,lon], 14);
      }, () => {
        alert("Kon locatie niet ophalen (HTTPS nodig).");
      });
    };

    /* AUTO REFRESH */
    load();
    setInterval(load, 30000);
    setInterval(updateTopStatus, 30000);

    /* SERVICE WORKER */
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js");
    }
  </script>
</body>
</html>
